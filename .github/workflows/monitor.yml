name: Vercel Error Monitor

on:
  schedule:
    # Run every 6 hours
    - cron: "0 */6 * * *"
  workflow_dispatch: # Allow manual trigger from GitHub UI

jobs:
  monitor:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - run: npm ci

      # Fetch Vercel logs and check for errors
      - name: Fetch Vercel logs
        id: logs
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        run: |
          npm i -g vercel

          # Fetch recent logs (timeout after 15s since vercel logs can stream)
          RAW_LOGS=$(timeout 15 vercel logs https://meantforgreatness.vercel.app --token "$VERCEL_TOKEN" 2>/dev/null || true)

          if [ -z "$RAW_LOGS" ]; then
            echo "No logs retrieved."
            echo "has_errors=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Filter for errors
          ERRORS=$(echo "$RAW_LOGS" | grep -iE "(error|ERR|500|exception|unhandled|fatal|ENOENT|TypeError|ReferenceError)" || true)

          if [ -z "$ERRORS" ]; then
            echo "No errors found. All clear."
            echo "has_errors=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Found errors:"
          echo "$ERRORS"

          # Save errors for Claude to read
          echo "$ERRORS" > /tmp/vercel-errors.txt
          echo "has_errors=true" >> "$GITHUB_OUTPUT"

      # Create a GitHub issue to notify about the errors
      - name: Create issue for detected errors
        if: steps.logs.outputs.has_errors == 'true'
        id: issue
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          ERRORS=$(cat /tmp/vercel-errors.txt)
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M UTC")

          ISSUE_URL=$(gh issue create \
            --title "ðŸš¨ Production errors detected - $TIMESTAMP" \
            --label "bug,automated" \
            --body "$(cat <<EOF
          ## Production Errors Detected

          The automated Vercel monitor found errors in the production logs at **$TIMESTAMP**.

          ### Errors
          \`\`\`
          $ERRORS
          \`\`\`

          ### Status
          â³ Claude Haiku is analyzing these errors and attempting to create a fix PR...

          ---
          *This issue was created automatically by the [Vercel Error Monitor](https://github.com/${{ github.repository }}/actions/workflows/monitor.yml)*
          EOF
          )")

          echo "issue_url=$ISSUE_URL" >> "$GITHUB_OUTPUT"
          echo "Created issue: $ISSUE_URL"

      # If errors found, let Claude analyze and fix
      - name: Claude analyzes and fixes errors
        id: claude
        if: steps.logs.outputs.has_errors == 'true'
        continue-on-error: true
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          # Install Claude Code
          npm i -g @anthropic-ai/claude-code

          ERRORS=$(cat /tmp/vercel-errors.txt)

          claude -p \
            --model claude-haiku \
            --allowedTools "Read,Edit,Bash(npm test),Bash(npm run test),Bash(git checkout -b *),Bash(git add *),Bash(git commit *),Bash(git push *),Bash(gh pr create *),Bash(git diff *),Bash(git status),Bash(git config *)" \
            "You are an automated error-fixing agent. Here are production errors from Vercel logs:

          \`\`\`
          $ERRORS
          \`\`\`

          Please:
          1. Analyze these errors and identify the root cause
          2. Find the relevant source files in this repo
          3. Create a fix on a new branch (use format: fix/auto-$(date +%Y-%m-%d)-description)
          4. Run tests to verify the fix works
          5. Push the branch and create a PR with a clear description of what broke and how you fixed it

          If the errors are transient (network timeouts, rate limits, etc.) and not caused by our code, just log your analysis and do NOT create a PR." \
          2>&1 | tee /tmp/claude-output.txt

      # Update the issue with Claude's result
      - name: Update issue with results
        if: steps.logs.outputs.has_errors == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          CLAUDE_OUTPUT=$(cat /tmp/claude-output.txt 2>/dev/null || echo "No output captured")
          # Truncate if too long for a comment
          if [ ${#CLAUDE_OUTPUT} -gt 60000 ]; then
            CLAUDE_OUTPUT="${CLAUDE_OUTPUT:0:60000}... (truncated)"
          fi

          if [ "${{ steps.claude.outcome }}" == "success" ]; then
            gh issue comment "${{ steps.issue.outputs.issue_url }}" --body "$(cat <<EOF
          ## âœ… Claude Haiku Analysis Complete

          Claude analyzed the errors and took action. Check for a new PR linked to this issue.

          <details>
          <summary>Claude's full output</summary>

          \`\`\`
          $CLAUDE_OUTPUT
          \`\`\`

          </details>
          EOF
          )"
          else
            gh issue comment "${{ steps.issue.outputs.issue_url }}" --body "$(cat <<EOF
          ## âŒ Claude could not fix the errors automatically

          The automated fix attempt failed. Please investigate manually.

          <details>
          <summary>Claude's output</summary>

          \`\`\`
          $CLAUDE_OUTPUT
          \`\`\`

          </details>

          ---
          **Next steps:** Open Claude Code locally and investigate these production errors.
          EOF
          )"
          fi
