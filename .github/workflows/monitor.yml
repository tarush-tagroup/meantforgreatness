name: Production Error Monitor

on:
  schedule:
    # Run every hour
    - cron: "0 * * * *"
  workflow_dispatch: # Allow manual trigger from GitHub UI

jobs:
  monitor:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      # Step 1: Check centralized logs â€” the SINGLE source of truth
      #
      # All log sources are already ingested into Vercel Blob storage:
      #   - Vercel runtime errors â†’ ingested by Vercel Cron (every 10 min)
      #   - Stripe webhook errors â†’ written directly by webhook handler
      #   - Resend email errors  â†’ written directly by webhook handler
      #   - Application errors   â†’ written directly by app code
      #
      # This monitor just READS from that single store.
      - name: Check centralized logs for errors
        id: check
        env:
          LOG_API_SECRET: ${{ secrets.LOG_API_SECRET }}
          BASE_URL: https://www.meantforgreatness.org
        run: |
          SINCE=$(date -u -d '1 hour ago' +%Y-%m-%dT%H:%M:%SZ 2>/dev/null || date -u -v-1H +%Y-%m-%dT%H:%M:%SZ 2>/dev/null || echo "")

          if [ -z "$LOG_API_SECRET" ]; then
            echo "LOG_API_SECRET not configured â€” skipping."
            echo "has_errors=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          LOGS=$(curl -sf -H "Authorization: Bearer $LOG_API_SECRET" \
            "$BASE_URL/api/admin/logs?level=error&since=$SINCE&limit=100" 2>/dev/null || echo "")

          if [ -z "$LOGS" ]; then
            echo "Could not fetch centralized logs (API may be unreachable)."
            echo "has_errors=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          ERROR_COUNT=$(echo "$LOGS" | jq '.pagination.total // 0' 2>/dev/null || echo "0")

          if [ "$ERROR_COUNT" = "0" ]; then
            echo "No errors in centralized logs. All clear. âœ…"
            echo "has_errors=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Found $ERROR_COUNT errors in centralized logs."

          # Format errors for the issue
          echo "$LOGS" | jq -r '.data[] | "\(.timestamp) [\(.source)] \(.message)"' > /tmp/errors.txt
          echo "has_errors=true" >> "$GITHUB_OUTPUT"
          echo "error_count=$ERROR_COUNT" >> "$GITHUB_OUTPUT"

      # Step 2: Create a GitHub issue with all errors
      - name: Create issue for detected errors
        if: steps.check.outputs.has_errors == 'true'
        id: issue
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          ERRORS=$(cat /tmp/errors.txt)
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M UTC")
          ERROR_COUNT=${{ steps.check.outputs.error_count }}

          BODY="## Production Errors Detected

          The automated monitor found **$ERROR_COUNT errors** at **$TIMESTAMP**.

          All errors below come from the centralized log (Vercel Blob storage), which includes:
          - Frontend JS errors (\`frontend:error\`, \`frontend:error-boundary\`)
          - API route errors (\`api:checkout\`, \`api:webhook:stripe\`, \`api:contact\`, \`api:class-logs\`)
          - DB errors (\`db:error\`, \`db:slow-query\`)
          - Middleware (\`request:auth-rejected\`, \`request:slow\`)
          - Vercel runtime errors (\`vercel:runtime\`)
          - Stripe webhook errors (\`webhook:stripe\`)
          - Resend email errors (\`webhook:resend\`)
          - Application errors (\`stripe:checkout\`, \`contact\`, \`ai:photos\`, etc.)

          ### Errors
          \`\`\`
          $ERRORS
          \`\`\`

          ### Status
          â³ Claude Haiku is analyzing these errors and attempting to create a fix PR...

          ---
          *This issue was created automatically by the [Error Monitor](https://github.com/${{ github.repository }}/actions/workflows/monitor.yml)*"

          # Ensure labels exist (create if missing â€” prevents workflow failure)
          gh label create "automated" --description "Created by automated monitor" --color "0E8A16" 2>/dev/null || true

          ISSUE_URL=$(gh issue create \
            --title "ðŸš¨ Production errors detected - $TIMESTAMP" \
            --label "bug,automated" \
            --body "$BODY")

          echo "issue_url=$ISSUE_URL" >> "$GITHUB_OUTPUT"
          echo "Created issue: $ISSUE_URL"

      # Step 3: Install deps + let Claude analyze and fix
      - name: Install dependencies
        if: steps.check.outputs.has_errors == 'true'
        run: npm ci

      - name: Claude analyzes and fixes errors
        id: claude
        if: steps.check.outputs.has_errors == 'true'
        continue-on-error: true
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          npm i -g @anthropic-ai/claude-code

          # Build the prompt in a file to avoid shell escaping issues
          cat > /tmp/claude-prompt.txt << 'PROMPT_END'
          You are an automated error-fixing agent for a Next.js 16 + React 19 charity website (Meant for Greatness). Here are production errors from the centralized log:

          ```
          PROMPT_END
          cat /tmp/errors.txt >> /tmp/claude-prompt.txt
          cat >> /tmp/claude-prompt.txt << 'PROMPT_END'
          ```

          Error sources: frontend:error (client-side JS errors), frontend:error-boundary (React error boundaries), api:* (API route errors/timeouts), db:error (database query failures), db:slow-query (slow DB queries >200ms), request:auth-rejected (middleware auth failures), request:slow (slow middleware >2s), vercel:runtime (Vercel function errors), webhook:stripe (Stripe payment/subscription issues), webhook:resend (email delivery issues), stripe:checkout (checkout flow), contact (contact form), ai:photos (photo analysis), geocode (geocoding).

          IMPORTANT GUIDELINES:
          - Read the CLAUDE.md file first for project context and architecture
          - Make MINIMAL, surgical fixes â€” do NOT remove features or make unrelated changes
          - React hydration errors (#418, #423) are often caused by browser extensions or dynamic content in server components â€” use suppressHydrationWarning where appropriate rather than converting server components to client components
          - If errors are transient (network timeouts, rate limits, browser extensions) and NOT caused by our code, just log your analysis and do NOT create a PR
          - Run `npm run build` and `npx vitest run` to verify your fix before pushing

          Steps:
          1. Read CLAUDE.md for project context
          2. Analyze the errors and identify the root cause
          3. Find the relevant source files
          4. If a code fix is needed, create a branch (format: fix/auto-YYYY-MM-DD-description)
          5. Make the minimal fix, verify with build + tests
          6. Push and create a PR with a clear description
          PROMPT_END

          cat /tmp/claude-prompt.txt | claude -p \
            --model claude-sonnet-4-5-20250929 \
            --allowedTools "Read,Glob,Grep,Edit,Bash(npm run build),Bash(npm test),Bash(npx vitest run),Bash(git checkout -b *),Bash(git add *),Bash(git commit *),Bash(git push *),Bash(gh pr create *),Bash(git diff *),Bash(git status),Bash(git config *)" \
          2>&1 | tee /tmp/claude-output.txt

      # Step 4: Record monitor run in centralized logs
      - name: Record monitor run
        if: always()
        env:
          LOG_API_SECRET: ${{ secrets.LOG_API_SECRET }}
          BASE_URL: https://www.meantforgreatness.org
        run: |
          ERROR_COUNT="${{ steps.check.outputs.error_count || '0' }}"
          HAS_ERRORS="${{ steps.check.outputs.has_errors || 'false' }}"

          if [ "$HAS_ERRORS" = "true" ]; then
            MSG="Monitor completed: found $ERROR_COUNT errors"
            LEVEL="warn"
          else
            MSG="Monitor completed: no errors found"
            LEVEL="info"
          fi

          curl -sf -X POST -H "Authorization: Bearer $LOG_API_SECRET" \
            -H "Content-Type: application/json" \
            "$BASE_URL/api/admin/logs/ingest" \
            -d "{\"entries\":[{\"level\":\"$LEVEL\",\"source\":\"monitor\",\"message\":\"$MSG\"}]}" \
            2>/dev/null || echo "Failed to record monitor run (non-fatal)"

      # Step 5: Record Claude API usage for cost tracking
      - name: Record Claude API usage
        if: steps.check.outputs.has_errors == 'true' && steps.claude.outcome == 'success'
        continue-on-error: true
        env:
          LOG_API_SECRET: ${{ secrets.LOG_API_SECRET }}
          BASE_URL: https://www.meantforgreatness.org
        run: |
          # Try to extract token counts from Claude CLI output
          # Claude Code outputs usage info like "Input tokens: 1234" and "Output tokens: 567"
          INPUT_TOKENS=$(grep -oP 'input.*?(\d[\d,]+)' /tmp/claude-output.txt 2>/dev/null | grep -oP '\d[\d,]+' | tail -1 | tr -d ',' || echo "0")
          OUTPUT_TOKENS=$(grep -oP 'output.*?(\d[\d,]+)' /tmp/claude-output.txt 2>/dev/null | grep -oP '\d[\d,]+' | tail -1 | tr -d ',' || echo "0")

          # Default to rough estimates if parsing fails
          if [ "$INPUT_TOKENS" = "0" ] && [ "$OUTPUT_TOKENS" = "0" ]; then
            # Estimate based on output length (rough heuristic)
            OUTPUT_CHARS=$(wc -c < /tmp/claude-output.txt 2>/dev/null || echo "0")
            INPUT_TOKENS=$((OUTPUT_CHARS / 2))
            OUTPUT_TOKENS=$((OUTPUT_CHARS / 4))
          fi

          curl -sf -X POST -H "Authorization: Bearer $LOG_API_SECRET" \
            -H "Content-Type: application/json" \
            "$BASE_URL/api/admin/anthropic-usage" \
            -d "{\"useCase\":\"monitor\",\"model\":\"claude-sonnet-4-5-20250929\",\"inputTokens\":$INPUT_TOKENS,\"outputTokens\":$OUTPUT_TOKENS}" \
            2>/dev/null || echo "Failed to record Claude usage (non-fatal)"

      # Step 6: Update issue with results
      - name: Update issue with results
        if: steps.check.outputs.has_errors == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          CLAUDE_OUTPUT=$(cat /tmp/claude-output.txt 2>/dev/null || echo "No output captured")
          # Truncate if too long for a comment
          if [ ${#CLAUDE_OUTPUT} -gt 60000 ]; then
            CLAUDE_OUTPUT="${CLAUDE_OUTPUT:0:60000}... (truncated)"
          fi

          if [ "${{ steps.claude.outcome }}" == "success" ]; then
            gh issue comment "${{ steps.issue.outputs.issue_url }}" --body "$(cat <<EOF
          ## âœ… Claude Haiku Analysis Complete

          Claude analyzed the errors and took action. Check for a new PR linked to this issue.

          <details>
          <summary>Claude's full output</summary>

          \`\`\`
          $CLAUDE_OUTPUT
          \`\`\`

          </details>
          EOF
          )"
          else
            gh issue comment "${{ steps.issue.outputs.issue_url }}" --body "$(cat <<EOF
          ## âŒ Claude could not fix the errors automatically

          The automated fix attempt failed. Please investigate manually.

          <details>
          <summary>Claude's output</summary>

          \`\`\`
          $CLAUDE_OUTPUT
          \`\`\`

          </details>

          ---
          **Next steps:** Open Claude Code locally and investigate these production errors.
          EOF
          )"
          fi
